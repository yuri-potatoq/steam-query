#include <libavformat/avformat.h>

int main(int argc, char *argv[]) {
    if (argc < 4) {
        fprintf(stderr, "usage: %s video.m4s audio.m4s output.mp4\n", argv[0]);
        return 1;
    }

    const char *input_video = argv[1];
    const char *input_audio = argv[2];
    const char *output_file = argv[3];

    AVFormatContext *in_video_ctx = NULL;
    AVFormatContext *in_audio_ctx = NULL;
    AVFormatContext *out_ctx = NULL;

    //av_register_all();

    // avformat_find_stream_info -> https://ffmpeg.org/doxygen/6.1/group__lavf__decoding.html#gad42172e27cddafb81096939783b157bb
    // Maybe we can mark as optional call
    
    // avformat_open_input -> https://ffmpeg.org/doxygen/6.1/group__lavf__decoding.html#gac05d61a2b492ae3985c658f34622c19d
    
    
    // --- Open inputs ---
    if (avformat_open_input(&in_video_ctx, input_video, NULL, NULL) < 0 || avformat_find_stream_info(in_video_ctx, NULL) < 0) {
        fprintf(stderr, "Could not open video input\n");
        return 1;
    }

    if (avformat_open_input(&in_audio_ctx, input_audio, NULL, NULL) < 0 ||avformat_find_stream_info(in_audio_ctx, NULL) < 0) {
        fprintf(stderr, "Could not open audio input\n");
        return 1;
    }

    // --- Create output context ---
    avformat_alloc_output_context2(&out_ctx, NULL, NULL, output_file);
    if (!out_ctx) {
        fprintf(stderr, "Could not create output context\n");
        return 1;
    }

    // --- Add video stream ---
    AVStream *out_video_stream = avformat_new_stream(out_ctx, NULL);
    
    // avcodec_parameters_copy -> https://ffmpeg.org/doxygen/4.4/codec__par_8c.html#a6d02e640ccc12c783841ce51d09b9fa7
    avcodec_parameters_copy(out_video_stream->codecpar, 
                            in_video_ctx->streams[0]->codecpar);
    out_video_stream->time_base = in_video_ctx->streams[0]->time_base;

    // --- Add audio stream ---
    AVStream *out_audio_stream = avformat_new_stream(out_ctx, NULL);
    avcodec_parameters_copy(out_audio_stream->codecpar,
                            in_audio_ctx->streams[0]->codecpar);
    out_audio_stream->time_base = in_audio_ctx->streams[0]->time_base;

    // --- Open output ---
    if (!(out_ctx->oformat->flags & AVFMT_NOFILE)) {
        if (avio_open(&out_ctx->pb, output_file, AVIO_FLAG_WRITE) < 0) {
            fprintf(stderr, "Could not open output file\n");
            return 1;
        }
    }

    // --- Write header ---
    avformat_write_header(out_ctx, NULL);

    AVPacket pkt;

    // --- Copy packets from video ---
    while (av_read_frame(in_video_ctx, &pkt) >= 0) {
        pkt.stream_index = out_video_stream->index;
        av_interleaved_write_frame(out_ctx, &pkt);
        av_packet_unref(&pkt);
    }

    // --- Copy packets from audio ---
    while (av_read_frame(in_audio_ctx, &pkt) >= 0) {
        pkt.stream_index = out_audio_stream->index;
        av_interleaved_write_frame(out_ctx, &pkt);
        av_packet_unref(&pkt);
    }

    // --- Finalize ---
    av_write_trailer(out_ctx);

    avformat_close_input(&in_video_ctx);
    avformat_close_input(&in_audio_ctx);
    if (!(out_ctx->oformat->flags & AVFMT_NOFILE))
        avio_closep(&out_ctx->pb);
    avformat_free_context(out_ctx);

    return 0;
}
